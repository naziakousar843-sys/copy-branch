<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Massage Suite Copy Branch Sahiwal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .whatsapp-bg { background-color: #25d366; }
        .whatsapp-hover:hover { background-color: #128c7e; }
        .break-words { word-break: break-all; }
        .send-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            color: #444;
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-100%); }
        }
        .removing { animation: fadeOut 0.5s ease-out forwards; }
    </style>
</head>

<body class="flex items-start justify-center min-h-screen p-4">

<div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl border-t-8 border-green-500 mt-8 mb-8">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-2 text-center">
        E-Massage Suit Copy Agency Sahiwal
    </h1>
    <p class="text-gray-500 mb-4 text-center text-base">
        Applicant Whatsapp Notification System
    </p>

    <div id="pasteTarget"
         class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-xl text-center cursor-text hover:bg-gray-50 transition duration-150 focus-within:border-green-500">
        <p class="font-semibold text-gray-700">üìã Paste Excel Data Here</p>
        <p class="text-sm text-gray-500"> **Add your Message and Mobile Column Here** </p>
        <p class="text-xs text-red-500 mt-2">
            **(Please Follow This Order):** Message Column (first) and Number Column (last).
        </p>
    </div>

    <button id="sendFirstButton" disabled
            class="send-button w-full py-3 mt-4 text-lg font-bold text-white rounded-xl whatsapp-bg hover:whatsapp-hover transition duration-150 shadow-lg disabled:bg-gray-400">
        **Send First message**
    </button>

    <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center text-sm font-medium hidden"></div>

    <div id="dataOutput" class="mt-8 overflow-x-auto max-h-[60vh]">
        <p class="text-center text-gray-500 mt-4 p-4 border rounded-lg bg-gray-50">
            **When Paste Accurately Completed Then Table Will Appear Here**
        </p>
    </div>
</div>

<script>
const COOLDOWN_SECONDS = 7;
let countdownInterval;
let loadedData = [];
const WHATSAPP_TAB_NAME = 'WhatsAppTargetTab';

function sanitizeInput(input) {
    return String(input || '').replace(/[^0-9]/g, '');
}

function setButtonsState(isDisabled) {
    const buttons = document.querySelectorAll('.send-button');
    const statusDiv = document.getElementById('statusMessage');
    buttons.forEach(button => {
        button.disabled = isDisabled;
        if (isDisabled) {
            button.classList.remove('whatsapp-bg', 'whatsapp-hover');
        } else {
            button.textContent = button.id === 'sendFirstButton' ? 'Send First message (Opening Message)' : 'Send Now';
            button.classList.add('whatsapp-bg');
        }
    });
    if (!isDisabled) {
        statusDiv.classList.add('hidden');
        statusDiv.textContent = '';
    }
}

function removeSentItemAndRerender(rowIndex) {
    if (rowIndex === 0 && loadedData.length > 0) {
        loadedData.shift();
        renderTable(loadedData);
        const statusDiv = document.getElementById('statusMessage');
        const remaining = loadedData.length;
        if (remaining > 0) {
            statusDiv.textContent = `‚úÖ Success: Message has been sent. Remaining messages: ${remaining}.`;
        } else {
            statusDiv.textContent = 'üì§ All messages have been sent.';
        }
    }
}

function startCooldownCountdown(rowIndex, whatsappUrl) {
    let seconds = COOLDOWN_SECONDS;
    setButtonsState(true);

    const statusDiv = document.getElementById('statusMessage');
    statusDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
    statusDiv.classList.add('bg-yellow-100', 'text-yellow-800');
    statusDiv.textContent = `‚è≤ Please wait ${seconds}s before sending message...`;

    countdownInterval = setInterval(() => {
        seconds--;
        const buttons = document.querySelectorAll('.send-button');
        buttons.forEach(button => button.textContent = `Please Wait ${seconds}s...`);

        if (seconds <= 0) {
            clearInterval(countdownInterval);

            // ‚úÖ After timer ends, open WhatsApp
            const openedWindow = window.open(whatsappUrl, WHATSAPP_TAB_NAME);
            if (openedWindow) openedWindow.focus();

            // ‚úÖ Remove the sent row and refresh table
            removeSentItemAndRerender(rowIndex);

            // ‚úÖ Enable buttons again
            setButtonsState(false);
        }
    }, 1000);
}

function openWhatsAppChat(rawPhoneNumber, messageText, rowIndex, event) {
    const statusDiv = document.getElementById('statusMessage');
    if (event.target.disabled) return;

    let cleanedNumber = sanitizeInput(rawPhoneNumber);
    if (!cleanedNumber.startsWith('92')) {
        if (cleanedNumber.startsWith('0') && cleanedNumber.length >= 10) {
            cleanedNumber = '92' + cleanedNumber.substring(1);
        } else if (cleanedNumber.length === 10 || cleanedNumber.length === 11) {
            cleanedNumber = '92' + cleanedNumber;
        } else {
            statusDiv.textContent = `‚ùå Error: Invalid number (${rawPhoneNumber})`;
            statusDiv.classList.remove('hidden');
            statusDiv.classList.add('bg-red-100', 'text-red-800');
            return;
        }
    }

    let messageProcessed = messageText
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/%0A/gi, '\n')
        .replace(/\\n/g, '\n');

    const encodedMessage = encodeURIComponent(messageProcessed);
    const whatsappUrl = `https://web.whatsapp.com/send/?phone=${cleanedNumber}&text=${encodedMessage}`;

    console.log("Will open after timer:", whatsappUrl);

    // ‚úÖ Start timer first, open WhatsApp after countdown
    startCooldownCountdown(rowIndex, whatsappUrl);
}

document.getElementById('sendFirstButton').onclick = function(event) {
    if (loadedData.length > 0) {
        openWhatsAppChat(loadedData[0].number, loadedData[0].message, 0, event);
    }
};

function renderTable(dataArray) {
    const outputDiv = document.getElementById('dataOutput');
    const firstRowButton = document.getElementById('sendFirstButton');

    if (dataArray.length === 0) {
        outputDiv.innerHTML = '<p class="text-center text-gray-500 mt-4 p-4 border rounded-lg bg-gray-50">üéâ All data has been sent.</p>';
        firstRowButton.disabled = true;
        return;
    }

    if (countdownInterval) clearInterval(countdownInterval);
    setButtonsState(false);

    let tableHTML = `
        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-md">
            <thead class="sticky top-0 bg-gray-100 z-10 shadow-sm">
                <tr>
                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Message (Ÿæ€åÿ∫ÿßŸÖ)</th>
                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Number (ŸÜŸÖÿ®ÿ±)</th>
                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Send</th>
                </tr>
            </thead>
            <tbody>
    `;

    dataArray.forEach((rowData, index) => {
        const message = rowData.message;
        const number = rowData.number;
        const safeMessage = message.replace(/'/g, "\\'");
        const isFirstRow = index === 0;
        const buttonHtml = isFirstRow
            ? `<button onclick="openWhatsAppChat('${number}', '${safeMessage}', ${index}, event)" class="send-button py-1 px-3 text-xs font-bold text-white rounded-full whatsapp-bg hover:whatsapp-hover transition duration-150 shadow-md">Send Now</button>`
            : `<button disabled class="send-button py-1 px-3 text-xs font-bold text-white rounded-full disabled:bg-gray-400">Pending</button>`;

        tableHTML += `
            <tr class="${isFirstRow ? 'bg-yellow-50 font-bold border-2 border-yellow-300' : (index % 2 === 0 ? 'bg-white' : 'bg-gray-50')} border-b border-gray-200">
                <td class="p-4 text-sm text-gray-800 break-words max-w-xs">${isFirstRow ? 'NEXT: ' : ''} ${message.length > 50 ? message.substring(0, 50) + '...' : message}</td>
                <td class="p-4 text-sm font-medium text-gray-700 whitespace-nowrap">${number}</td>
                <td class="p-4 text-center">${buttonHtml}</td>
            </tr>
        `;
    });

    tableHTML += '</tbody></table>';
    outputDiv.innerHTML = tableHTML;
    document.getElementById('sendFirstButton').disabled = true;
}

function processPastedData(event) {
    event.preventDefault();
    const pasteData = (event.clipboardData || window.clipboardData).getData('text');
    const dataArray = [];
    const rows = pasteData.trim().split('\n');

    rows.forEach(row => {
        const columns = row.trim().split(/[\t,]+/);
        if (columns.length >= 2) {
            const rawNumber = columns[columns.length - 1].trim();
            const message = columns[columns.length - 2].trim();
            const numberOnly = sanitizeInput(rawNumber);
            if (numberOnly.length >= 10 && numberOnly.length <= 15) {
                dataArray.push({ number: rawNumber, message: message });
            }
        }
    });

    loadedData = dataArray;
    const statusDiv = document.getElementById('statusMessage');
    if (loadedData.length > 0) {
        statusDiv.textContent = `‚úÖ Success: ${loadedData.length} rows loaded. Click 'Send Now' to begin.`;
        statusDiv.classList.add('bg-green-100', 'text-green-800');
        statusDiv.classList.remove('bg-red-100', 'text-red-800', 'hidden');
    } else {
        statusDiv.textContent = '‚ùå Error: Data not copied properly. Please try again.';
        statusDiv.classList.add('bg-red-100', 'text-red-800');
        statusDiv.classList.remove('bg-green-100', 'text-green-800', 'hidden');
    }

    renderTable(loadedData);
}

document.getElementById('pasteTarget').addEventListener('paste', processPastedData);
</script>

</body>
</html>

